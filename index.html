<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K√≠ch ho·∫°t t√†i kho·∫£n - Educare Connect</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 480px;
        width: 100%;
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px 30px;
        text-align: center;
        color: white;
      }

      .logo {
        width: 80px;
        height: 80px;
        background: white;
        border-radius: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .logo-text {
        font-size: 36px;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
      }

      .content {
        padding: 40px 30px;
      }

      .status {
        text-align: center;
        padding: 20px;
      }

      .status.loading {
        color: #4a5568;
      }

      .status.error {
        color: #e53e3e;
      }

      .status.success {
        color: #38a169;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #2d3748;
        font-weight: 600;
        font-size: 14px;
      }

      .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .password-requirements {
        margin-top: 8px;
        padding: 12px;
        background: #f7fafc;
        border-radius: 6px;
        font-size: 13px;
      }

      .password-requirements li {
        margin: 4px 0;
        color: #718096;
      }

      .password-requirements li.valid {
        color: #38a169;
      }

      .password-requirements li.invalid {
        color: #e53e3e;
      }

      .btn {
        width: 100%;
        padding: 14px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .info-box {
        margin-top: 20px;
        padding: 16px;
        background: #ebf8ff;
        border-left: 4px solid #4299e1;
        border-radius: 4px;
        font-size: 14px;
        color: #2c5282;
      }

      .error-box {
        margin-top: 20px;
        padding: 16px;
        background: #fff5f5;
        border-left: 4px solid #fc8181;
        border-radius: 4px;
        font-size: 14px;
        color: #c53030;
      }

      .success-box {
        margin-top: 20px;
        padding: 16px;
        background: #f0fff4;
        border-left: 4px solid #68d391;
        border-radius: 4px;
        font-size: 14px;
        color: #2f855a;
      }

      .footer {
        text-align: center;
        padding: 20px;
        color: #a0aec0;
        font-size: 13px;
      }

      #passwordForm {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="logo">
          <span class="logo-text">EC</span>
        </div>
        <h1>Educare Connect</h1>
      </div>

      <!-- Content -->
      <div class="content">
        <!-- Loading Status -->
        <div id="loadingStatus" class="status loading">
          <div class="spinner"></div>
          <p>ƒêang x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n...</p>
        </div>

        <!-- Error Status -->
        <div id="errorStatus" class="status error" style="display: none">
          <h2 style="margin-bottom: 12px">‚ùå C√≥ l·ªói x·∫£y ra</h2>
          <p id="errorMessage"></p>
        </div>

        <!-- Password Form -->
        <form id="passwordForm">
          <h2 style="margin-bottom: 20px; color: #2d3748">
            üîê T·∫°o m·∫≠t kh·∫©u m·ªõi
          </h2>

          <div class="form-group">
            <label for="password">M·∫≠t kh·∫©u m·ªõi</label>
            <input
              type="password"
              id="password"
              placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi"
              required
            />
          </div>

          <div class="form-group">
            <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
            <input
              type="password"
              id="confirmPassword"
              placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
              required
            />
          </div>

          <div class="password-requirements">
            <strong>Y√™u c·∫ßu m·∫≠t kh·∫©u:</strong>
            <ul id="requirements">
              <li id="req-length">‚Ä¢ T·ªëi thi·ªÉu 8 k√Ω t·ª±</li>
              <li id="req-match">‚Ä¢ M·∫≠t kh·∫©u kh·ªõp nhau</li>
            </ul>
          </div>

          <button type="submit" class="btn" id="submitBtn">
            X√°c nh·∫≠n m·∫≠t kh·∫©u
          </button>

          <div class="info-box">
            üí° Sau khi t·∫°o m·∫≠t kh·∫©u, b·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn ·ª©ng d·ª•ng ƒë·ªÉ ƒëƒÉng
            nh·∫≠p.
          </div>
        </form>

        <!-- Success Status -->
        <div id="successStatus" style="display: none">
          <div class="status success">
            <h2 style="margin-bottom: 12px">‚úÖ Th√†nh c√¥ng!</h2>
            <p>M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p. ƒêang m·ªü ·ª©ng d·ª•ng...</p>
          </div>
          <div class="success-box">
            N·∫øu ·ª©ng d·ª•ng kh√¥ng t·ª± ƒë·ªông m·ªü, vui l√≤ng m·ªü ·ª©ng d·ª•ng Educare Connect
            v√† ƒëƒÉng nh·∫≠p b·∫±ng email v√† m·∫≠t kh·∫©u v·ª´a t·∫°o.
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        ¬© 2025 Educare Connect<br />
        <a
          href="mailto:support@educareconnect.com"
          style="color: #667eea; text-decoration: none"
        >
          support@educareconnect.com
        </a>
      </div>
    </div>

    <script>
      // Parse URL hash parameters
      function parseHashParams() {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        return {
          access_token: params.get("access_token"),
          refresh_token: params.get("refresh_token"),
          type: params.get("type"),
          error: params.get("error"),
          error_description: params.get("error_description"),
        };
      }

      // Show error
      function showError(message) {
        document.getElementById("loadingStatus").style.display = "none";
        document.getElementById("errorStatus").style.display = "block";
        document.getElementById("errorMessage").textContent = message;
      }

      // Show password form
      function showPasswordForm() {
        document.getElementById("loadingStatus").style.display = "none";
        document.getElementById("passwordForm").style.display = "block";
      }

      // Show success
      function showSuccess() {
        document.getElementById("passwordForm").style.display = "none";
        document.getElementById("successStatus").style.display = "block";
      }

      // Validate password
      function validatePassword() {
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        const lengthValid = password.length >= 8;
        const matchValid = password === confirmPassword && password.length > 0;

        document.getElementById("req-length").className = lengthValid
          ? "valid"
          : "invalid";
        document.getElementById("req-match").className = matchValid
          ? "valid"
          : "invalid";

        return lengthValid && matchValid;
      }

      // Update password with Supabase (for invited users)
      async function acceptInviteAndSetPassword(accessToken, password) {
        const SUPABASE_URL = "https://jlmjhcwmvpxvmuppzdks.supabase.co";
        const SUPABASE_ANON_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbWpoY3dtdnB4dm11cHB6ZGtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA4MDUwNjQsImV4cCI6MjA0NjM4MTA2NH0.QgYN5Lg0FZS1q5JGLLwdH3fS5m3Fj3yAm31DgvHG2AQ";

        console.log("Setting password for invited user...");

        // First, verify the invite token by getting user info
        const verifyResponse = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${accessToken}`,
            apikey: SUPABASE_ANON_KEY,
          },
        });

        if (!verifyResponse.ok) {
          const error = await verifyResponse.json();
          console.error("Verify token error:", error);
          throw new Error("Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n");
        }

        const userData = await verifyResponse.json();
        console.log("User verified:", userData);

        // Now update the password
        const updateResponse = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${accessToken}`,
            apikey: SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({
            password: password,
          }),
        });

        if (!updateResponse.ok) {
          const error = await updateResponse.json();
          console.error("Update password error:", error);
          throw new Error(error.msg || error.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t m·∫≠t kh·∫©u");
        }

        const result = await updateResponse.json();
        console.log("Password updated successfully:", result);
        
        return {
          user: result.user || userData,
          session: result,
        };
      }

      // Open app with deep link
      function openApp(accessToken, refreshToken) {
        // Build deep link with available tokens
        let deepLink = `educareconnect://auth?access_token=${accessToken}&type=invite`;
        if (refreshToken) {
          deepLink += `&refresh_token=${refreshToken}`;
        }

        console.log("Opening app with deep link:", deepLink);

        // Try to open the app
        window.location.href = deepLink;

        // Fallback: Show manual instruction after 3 seconds
        setTimeout(() => {
          console.log("App might not be installed or failed to open");
          // You could show a message here with download links
        }, 3000);
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        const params = parseHashParams();

        // Check for errors
        if (params.error) {
          showError(
            params.error_description || "ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i."
          );
          return;
        }

        // Check for required tokens
        if (!params.access_token) {
          showError(
            "Link kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n. Vui l√≤ng y√™u c·∫ßu gi√°o vi√™n g·ª≠i l·∫°i l·ªùi m·ªùi."
          );
          return;
        }

        // Store tokens
        sessionStorage.setItem("access_token", params.access_token);
        if (params.refresh_token) {
          sessionStorage.setItem("refresh_token", params.refresh_token);
        }

        // Show password form
        setTimeout(() => {
          showPasswordForm();
        }, 500);
      });

      // Password input validation
      document.getElementById("password")?.addEventListener("input", () => {
        validatePassword();
      });

      document
        .getElementById("confirmPassword")
        ?.addEventListener("input", () => {
          validatePassword();
        });

      // Form submission
      document
        .getElementById("passwordForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!validatePassword()) {
            alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u h·ª£p l·ªá");
            return;
          }

          const password = document.getElementById("password").value;
          const accessToken = sessionStorage.getItem("access_token");
          const refreshToken = sessionStorage.getItem("refresh_token");

          const submitBtn = document.getElementById("submitBtn");
          submitBtn.disabled = true;
          submitBtn.textContent = "ƒêang x·ª≠ l√Ω...";

          try {
            // Update password via Supabase API
            await updatePassword(accessToken, password);

            // Show success
            showSuccess();

            // Wait a bit then open app
            setTimeout(() => {
              openApp(accessToken, refreshToken);
            }, 1500);
          } catch (error) {
            alert("L·ªói: " + error.message);
            submitBtn.disabled = false;
            submitBtn.textContent = "X√°c nh·∫≠n m·∫≠t kh·∫©u";
          }
        });
    </script>
  </body>
</html>
