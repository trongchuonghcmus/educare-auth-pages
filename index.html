<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Educare Connect - X√°c th·ª±c</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 100%;
        text-align: center;
      }

      .logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }

      .status {
        font-size: 18px;
        margin: 20px 0;
        padding: 15px;
        border-radius: 10px;
      }

      .status.loading {
        background: #f0f4ff;
        color: #4c6ef5;
      }

      .status.success {
        background: #d3f9d8;
        color: #2f9e44;
      }

      .status.error {
        background: #ffe3e3;
        color: #c92a2a;
      }

      .message {
        color: #666;
        line-height: 1.6;
        margin: 20px 0;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .button {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 40px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        margin-top: 20px;
        transition: transform 0.2s;
      }

      .button:hover {
        transform: translateY(-2px);
      }

      .countdown {
        color: #999;
        font-size: 14px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo">üìö</div>
      <h1>Educare Connect</h1>

      <div id="content">
        <div class="status loading">
          <div class="spinner"></div>
          <p>ƒêang x·ª≠ l√Ω x√°c th·ª±c...</p>
        </div>
      </div>
    </div>

    <script>
      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const fragment = new URLSearchParams(window.location.hash.substring(1));

      // Get tokens from URL (Supabase sends them in hash fragment)
      const access_token =
        fragment.get("access_token") || urlParams.get("access_token");
      const refresh_token =
        fragment.get("refresh_token") || urlParams.get("refresh_token");
      const type = fragment.get("type") || urlParams.get("type");
      const error = fragment.get("error") || urlParams.get("error");
      const error_description =
        fragment.get("error_description") || urlParams.get("error_description");

      console.log("Auth page loaded:", {
        type,
        error,
        hasTokens: !!(access_token && refresh_token),
      });

      function showContent(status, title, message, autoRedirect = true) {
        const content = document.getElementById("content");
        const statusClass =
          status === "success"
            ? "success"
            : status === "error"
            ? "error"
            : "loading";

        let html = `
                <div class="status ${statusClass}">
                    ${
                      status === "success"
                        ? "‚úì"
                        : status === "error"
                        ? "‚úï"
                        : "‚è≥"
                    }
                    <h2>${title}</h2>
                </div>
                <p class="message">${message}</p>
            `;

        if (autoRedirect && status === "success") {
          html += '<p class="countdown">ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn ·ª©ng d·ª•ng...</p>';
        }

        content.innerHTML = html;
      }

      function redirectToApp(action) {
        // Construct deep link URL
        const deepLinkBase = "educareconnect://auth/" + action;
        const params = new URLSearchParams();

        if (access_token) params.append("access_token", access_token);
        if (refresh_token) params.append("refresh_token", refresh_token);

        const deepLinkUrl = deepLinkBase + "?" + params.toString();

        console.log("Redirecting to app:", deepLinkUrl);

        // Try to open the app
        window.location.href = deepLinkUrl;

        // Fallback: show instructions after 3 seconds if app didn't open
        setTimeout(() => {
          const content = document.getElementById("content");
          content.innerHTML += `
                    <div class="message" style="margin-top: 30px;">
                        <p><strong>Kh√¥ng m·ªü ƒë∆∞·ª£c ·ª©ng d·ª•ng?</strong></p>
                        <p style="margin-top: 10px;">Vui l√≤ng m·ªü ·ª©ng d·ª•ng Educare Connect th·ªß c√¥ng ƒë·ªÉ ti·∫øp t·ª•c.</p>
                        <a href="${deepLinkUrl}" class="button">M·ªü ·ª©ng d·ª•ng</a>
                    </div>
                `;
        }, 3000);
      }

      // Handle different auth types
      if (error) {
        // Error case
        showContent(
          "error",
          "X√°c th·ª±c th·∫•t b·∫°i",
          error_description || "ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.",
          false
        );
      } else if (!access_token || !refresh_token) {
        // Missing tokens
        showContent(
          "error",
          "Thi·∫øu th√¥ng tin x√°c th·ª±c",
          "Link x√°c th·ª±c kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.",
          false
        );
      } else {
        // Success - handle different types
        switch (type) {
          case "signup":
          case "email_confirmation":
            showContent(
              "success",
              "X√°c nh·∫≠n email th√†nh c√¥ng!",
              "T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n. B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√†o ·ª©ng d·ª•ng."
            );
            setTimeout(() => redirectToApp("confirmed"), 2000);
            break;

          case "recovery":
          case "reset_password":
            showContent(
              "success",
              "X√°c th·ª±c th√†nh c√¥ng!",
              "B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u."
            );
            setTimeout(() => redirectToApp("reset-password"), 2000);
            break;

          case "email_change":
            showContent(
              "success",
              "Email ƒë√£ ƒë∆∞·ª£c thay ƒë·ªïi!",
              "ƒê·ªãa ch·ªâ email m·ªõi c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n."
            );
            setTimeout(() => redirectToApp("email-changed"), 2000);
            break;

          case "invite":
            showContent(
              "success",
              "L·ªùi m·ªùi ƒë∆∞·ª£c ch·∫•p nh·∫≠n!",
              "Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Educare Connect."
            );
            setTimeout(() => redirectToApp("invite-accepted"), 2000);
            break;

          default:
            showContent(
              "success",
              "X√°c th·ª±c th√†nh c√¥ng!",
              "ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn ·ª©ng d·ª•ng..."
            );
            setTimeout(() => redirectToApp("confirmed"), 2000);
        }
      }
    </script>
  </body>
</html>
