<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Educare Connect - X√°c th·ª±c</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Oxygen", "Ubuntu", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        max-width: 480px;
        width: 100%;
      }

      .logo-section {
        text-align: center;
        margin-bottom: 30px;
        animation: fadeInDown 0.6s ease-out;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo {
        width: 80px;
        height: 80px;
        background: white;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-bottom: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .app-name {
        color: white;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 4px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .tagline {
        color: rgba(255, 255, 255, 0.95);
        font-size: 15px;
        font-weight: 500;
      }

      .card {
        background: white;
        border-radius: 24px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: fadeInUp 0.6s ease-out 0.2s both;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-container {
        text-align: center;
      }

      /* Loading State */
      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 24px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: #666;
        font-size: 16px;
        font-weight: 500;
      }

      /* Status Icons */
      .status-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        font-size: 48px;
        animation: scaleIn 0.5s ease-out;
      }

      @keyframes scaleIn {
        from {
          transform: scale(0);
        }
        to {
          transform: scale(1);
        }
      }

      .success-icon {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      }

      .error-icon {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      }

      .status-title {
        font-size: 26px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #2d3748;
      }

      .status-message {
        color: #4a5568;
        line-height: 1.7;
        margin-bottom: 24px;
        font-size: 15px;
      }

      .error-details {
        background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
        border: 2px solid #ffc107;
        border-radius: 12px;
        padding: 16px;
        margin: 20px 0;
        font-size: 13px;
        color: #856404;
        text-align: left;
        font-family: "Courier New", monospace;
        word-break: break-word;
      }

      /* Buttons */
      .btn {
        display: block;
        width: 100%;
        padding: 16px 32px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        text-align: center;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
        color: #2d3748;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-top: 12px;
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .auto-redirect {
        margin-top: 16px;
        padding: 12px;
        background: #f7fafc;
        border-radius: 8px;
        font-size: 13px;
        color: #718096;
      }

      .countdown {
        font-weight: 700;
        color: #667eea;
      }

      /* Desktop instructions */
      .desktop-instructions {
        margin-top: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
        border: 2px solid #ffc107;
        border-radius: 12px;
      }

      .desktop-instructions h3 {
        color: #856404;
        font-size: 16px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .desktop-instructions ol {
        color: #856404;
        font-size: 14px;
        margin-left: 20px;
        line-height: 1.8;
      }

      .desktop-instructions li {
        margin-bottom: 8px;
      }

      .qr-placeholder {
        margin-top: 16px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        text-align: center;
        font-size: 13px;
        color: #666;
      }

      /* Footer */
      .footer {
        text-align: center;
        color: white;
        margin-top: 24px;
        font-size: 14px;
        opacity: 0.95;
        animation: fadeIn 1s ease-out 0.8s both;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .footer a {
        color: white;
        text-decoration: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.5);
      }

      .footer a:hover {
        border-bottom-color: white;
      }

      /* Hidden class */
      .hidden {
        display: none !important;
      }

      /* Responsive */
      @media (max-width: 480px) {
        .card {
          padding: 32px 24px;
        }

        .status-title {
          font-size: 22px;
        }

        .app-name {
          font-size: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Logo Section -->
      <div class="logo-section">
        <div class="logo">EC</div>
        <div class="app-name">Educare Connect</div>
        <div class="tagline">·ª®ng d·ª•ng gi√°o d·ª•c ƒë·∫∑c bi·ªát</div>
      </div>

      <!-- Main Card -->
      <div class="card">
        <!-- Loading State -->
        <div id="loading-state" class="status-container">
          <div class="loading-spinner"></div>
          <div class="loading-text">ƒêang x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n...</div>
        </div>

        <!-- Success State -->
        <div id="success-state" class="status-container hidden">
          <div class="status-icon success-icon">‚úì</div>
          <h1 class="status-title" id="success-title">Th√†nh c√¥ng!</h1>
          <p class="status-message" id="success-message"></p>

          <!-- Mobile: Auto redirect -->
          <div id="mobile-redirect" class="hidden">
            <a href="#" id="success-btn" class="btn">M·ªü ·ª©ng d·ª•ng</a>
            <div class="auto-redirect" id="auto-redirect">
              T·ª± ƒë·ªông chuy·ªÉn trong
              <span class="countdown" id="countdown">3</span> gi√¢y...
            </div>
          </div>

          <!-- Desktop: Instructions -->
          <div id="desktop-instructions" class="hidden">
            <div class="desktop-instructions">
              <h3>
                <span>üíª</span>
                <span>B·∫°n ƒëang s·ª≠ d·ª•ng m√°y t√≠nh</span>
              </h3>
              <p style="margin-bottom: 12px; font-size: 14px">
                ƒê·ªÉ ho√†n t·∫•t ƒëƒÉng nh·∫≠p, vui l√≤ng m·ªü ·ª©ng d·ª•ng tr√™n ƒëi·ªán tho·∫°i:
              </p>
              <ol>
                <li>
                  M·ªü ·ª©ng d·ª•ng <strong>Educare Connect</strong> tr√™n ƒëi·ªán tho·∫°i
                </li>
                <li>ƒêƒÉng nh·∫≠p v·ªõi email v√† m·∫≠t kh·∫©u v·ª´a t·∫°o</li>
                <li>B·∫°n ƒë√£ s·∫µn s√†ng s·ª≠ d·ª•ng!</li>
              </ol>
              <div class="qr-placeholder">
                üì± Qu√©t m√£ QR ƒë·ªÉ t·∫£i ·ª©ng d·ª•ng<br />
                <small style="color: #999">(Coming soon)</small>
              </div>
            </div>
            <button
              onclick="window.close()"
              class="btn btn-secondary"
              style="margin-top: 16px"
            >
              ƒê√≥ng trang n√†y
            </button>
          </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="status-container hidden">
          <div class="status-icon error-icon">‚úï</div>
          <h1 class="status-title" id="error-title">C√≥ l·ªói x·∫£y ra</h1>
          <p class="status-message" id="error-message"></p>
          <div id="error-details" class="error-details hidden"></div>
          <button onclick="retryAuth()" class="btn">Th·ª≠ l·∫°i</button>
          <button onclick="window.close()" class="btn btn-secondary">
            ƒê√≥ng trang
          </button>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        ¬© 2025 Educare Connect<br />
        <a href="mailto:support@educareconnect.com"
          >support@educareconnect.com</a
        >
      </div>
    </div>

    <script>
      // Parse URL parameters from both query string and hash
      function getParams() {
        const params = new URLSearchParams(window.location.search);
        const hash = new URLSearchParams(window.location.hash.substring(1));

        return {
          type: params.get("type") || hash.get("type"),
          access_token: hash.get("access_token") || params.get("access_token"),
          refresh_token:
            hash.get("refresh_token") || params.get("refresh_token"),
          error: params.get("error") || hash.get("error"),
          error_description:
            params.get("error_description") || hash.get("error_description"),
          error_code: params.get("error_code") || hash.get("error_code"),
        };
      }

      const params = getParams();
      let countdownInterval;
      let isMobile = false;

      // Detect if user is on mobile device
      function detectMobile() {
        const userAgent = navigator.userAgent.toLowerCase();
        const mobileKeywords = [
          "android",
          "iphone",
          "ipad",
          "ipod",
          "mobile",
          "phone",
        ];
        isMobile = mobileKeywords.some((keyword) =>
          userAgent.includes(keyword)
        );

        // Also check screen size
        if (!isMobile && window.innerWidth <= 768) {
          isMobile = true;
        }

        console.log("Device detected:", isMobile ? "Mobile" : "Desktop");
        return isMobile;
      }

      // Show different states
      function showLoading() {
        document.getElementById("loading-state").classList.remove("hidden");
        document.getElementById("success-state").classList.add("hidden");
        document.getElementById("error-state").classList.add("hidden");
      }

      function showSuccess(title, message, deepLink) {
        document.getElementById("loading-state").classList.add("hidden");
        document.getElementById("success-state").classList.remove("hidden");
        document.getElementById("error-state").classList.add("hidden");

        document.getElementById("success-title").textContent = title;
        document.getElementById("success-message").textContent = message;

        // Detect device and show appropriate UI
        detectMobile();

        if (isMobile) {
          // Mobile: Show button and auto-redirect
          document.getElementById("mobile-redirect").classList.remove("hidden");
          document
            .getElementById("desktop-instructions")
            .classList.add("hidden");

          const btn = document.getElementById("success-btn");
          btn.href = deepLink;
          btn.onclick = () => {
            window.location.href = deepLink;
          };

          // Start countdown
          startCountdown(deepLink);
        } else {
          // Desktop: Show instructions
          document.getElementById("mobile-redirect").classList.add("hidden");
          document
            .getElementById("desktop-instructions")
            .classList.remove("hidden");
        }
      }

      function showError(title, message, details = null) {
        document.getElementById("loading-state").classList.add("hidden");
        document.getElementById("success-state").classList.add("hidden");
        document.getElementById("error-state").classList.remove("hidden");

        document.getElementById("error-title").textContent = title;
        document.getElementById("error-message").textContent = message;

        if (details) {
          const detailsEl = document.getElementById("error-details");
          detailsEl.textContent = details;
          detailsEl.classList.remove("hidden");
        }
      }

      // Countdown timer
      function startCountdown(deepLink) {
        let seconds = 3;
        const countdownEl = document.getElementById("countdown");

        countdownInterval = setInterval(() => {
          seconds--;
          countdownEl.textContent = seconds;

          if (seconds <= 0) {
            clearInterval(countdownInterval);
            window.location.href = deepLink;
          }
        }, 1000);
      }

      // Retry function
      function retryAuth() {
        clearInterval(countdownInterval);
        showLoading();
        setTimeout(handleAuth, 500);
      }

      // Main authentication handler
      function handleAuth() {
        console.log("Params received:", params);

        // Check for errors first
        if (params.error) {
          const errorMessages = {
            access_denied: "B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p.",
            server_error: "L·ªói m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.",
            temporarily_unavailable: "D·ªãch v·ª• t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng.",
            invalid_request: "Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá.",
            unauthorized_client: "·ª®ng d·ª•ng kh√¥ng ƒë∆∞·ª£c ·ªßy quy·ªÅn.",
            invalid_grant: "Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.",
          };

          showError(
            "X√°c th·ª±c th·∫•t b·∫°i",
            errorMessages[params.error] ||
              "Kh√¥ng th·ªÉ ho√†n t·∫•t x√°c th·ª±c. Vui l√≤ng th·ª≠ l·∫°i.",
            params.error_description || params.error
          );
          return;
        }

        // Handle different authentication types
        switch (params.type) {
          case "signup":
            handleSignup();
            break;
          case "recovery":
            handleRecovery();
            break;
          case "email_change":
            handleEmailChange();
            break;
          case "invite":
            handleInvite();
            break;
          case "magiclink":
            handleMagicLink();
            break;
          default:
            showError(
              "Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá",
              "Kh√¥ng t√¨m th·∫•y lo·∫°i x√°c th·ª±c. Vui l√≤ng ki·ªÉm tra l·∫°i link t·ª´ email.",
              `Type: ${params.type || "undefined"}`
            );
        }
      }

      function handleSignup() {
        if (params.access_token && params.refresh_token) {
          const deepLink = `educareconnect://auth/confirmed?access_token=${params.access_token}&refresh_token=${params.refresh_token}`;
          showSuccess(
            "X√°c nh·∫≠n th√†nh c√¥ng!",
            "Email c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c. B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√†o ·ª©ng d·ª•ng Educare Connect ngay b√¢y gi·ªù.",
            deepLink
          );
        } else {
          showError(
            "L·ªói x√°c nh·∫≠n",
            "Link x√°c nh·∫≠n kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.",
            "Vui l√≤ng y√™u c·∫ßu g·ª≠i l·∫°i email x√°c nh·∫≠n t·ª´ ·ª©ng d·ª•ng."
          );
        }
      }

      function handleRecovery() {
        if (params.access_token && params.refresh_token) {
          const deepLink = `educareconnect://auth/reset-password?access_token=${params.access_token}&refresh_token=${params.refresh_token}`;
          showSuccess(
            "Link h·ª£p l·ªá!",
            "B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn ·ª©ng d·ª•ng ƒë·ªÉ t·∫°o m·∫≠t kh·∫©u m·ªõi. Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi trong ·ª©ng d·ª•ng.",
            deepLink
          );
        } else {
          showError(
            "Link kh√¥ng h·ª£p l·ªá",
            "Link ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.",
            "Vui l√≤ng y√™u c·∫ßu g·ª≠i l·∫°i link ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u t·ª´ ·ª©ng d·ª•ng."
          );
        }
      }

      function handleEmailChange() {
        if (params.access_token && params.refresh_token) {
          const deepLink = `educareconnect://auth/email-changed?access_token=${params.access_token}&refresh_token=${params.refresh_token}`;
          showSuccess(
            "Email ƒë√£ c·∫≠p nh·∫≠t!",
            "Email m·ªõi c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n th√†nh c√¥ng. Vui l√≤ng s·ª≠ d·ª•ng email m·ªõi cho c√°c l·∫ßn ƒëƒÉng nh·∫≠p ti·∫øp theo.",
            deepLink
          );
        } else {
          showError(
            "X√°c nh·∫≠n th·∫•t b·∫°i",
            "Kh√¥ng th·ªÉ x√°c nh·∫≠n email m·ªõi. Link c√≥ th·ªÉ ƒë√£ h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá.",
            "Vui l√≤ng th·ª≠ l·∫°i t·ª´ c√†i ƒë·∫∑t trong ·ª©ng d·ª•ng."
          );
        }
      }

      function handleInvite() {
        if (params.access_token && params.refresh_token) {
          const deepLink = `educareconnect://auth/invite-accepted?access_token=${params.access_token}&refresh_token=${params.refresh_token}`;
          showSuccess(
            "Ch√†o m·ª´ng b·∫°n!",
            "L·ªùi m·ªùi ƒë√£ ƒë∆∞·ª£c ch·∫•p nh·∫≠n. B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√†o ·ª©ng d·ª•ng ngay b√¢y gi·ªù.",
            deepLink
          );
        } else {
          showError(
            "L·ªùi m·ªùi kh√¥ng h·ª£p l·ªá",
            "Link l·ªùi m·ªùi kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.",
            "Vui l√≤ng y√™u c·∫ßu g·ª≠i l·∫°i l·ªùi m·ªùi."
          );
        }
      }

      function handleMagicLink() {
        if (params.access_token && params.refresh_token) {
          const deepLink = `educareconnect://auth/magiclink?access_token=${params.access_token}&refresh_token=${params.refresh_token}`;
          showSuccess(
            "ƒêƒÉng nh·∫≠p th√†nh c√¥ng!",
            "B·∫°n ƒëang ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn ·ª©ng d·ª•ng...",
            deepLink
          );
        } else {
          showError(
            "Link kh√¥ng h·ª£p l·ªá",
            "Magic link kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.",
            "Vui l√≤ng y√™u c·∫ßu g·ª≠i l·∫°i magic link m·ªõi."
          );
        }
      }

      // Initialize
      window.addEventListener("load", () => {
        showLoading();
        // Simulate processing time for better UX
        setTimeout(handleAuth, 1200);
      });

      // Clean up on page unload
      window.addEventListener("beforeunload", () => {
        if (countdownInterval) {
          clearInterval(countdownInterval);
        }
      });
    </script>
  </body>
</html>
